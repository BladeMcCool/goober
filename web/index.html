<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
 	<script type="text/javascript">
 		recaptcha_sitekey = 'tbd'

		function ajax(url, successFunc, timeout, timeoutFunc) {
			const Http = new XMLHttpRequest();
			// const url= 'http://' + window.location.hostname + ':8081' + '/?t=' + token;
			Http.open("GET", url);
			Http.send();
			if (timeout) {
				Http.timeout = timeout
				if (timeoutFunc) {
					Http.ontimeout = timeoutFunc
				}
			}
			Http.onreadystatechange=(e)=>{
				if (Http.readyState !== 4) { //state 4 is complete
					return
				}
				if (Http.status !== 200 && Http.status !== 204) {
					console.log("poop, didnt work.")
					return
				}
				console.log(Http.responseText)
				successFunc(Http.responseText)
			}
			console.log(`ajax sent to: ${url}`)
		}
		function blockingAjax(url, timeoutMs) {
			return new Promise(resolve => {
				doneFunc = function(responseText) {
					resolve(responseText)
				}
				timeoutFunc = function() {
					console.log('blockingAjax timed out on that call.')
					resolve(JSON.stringify({timedout:true}))
				}
				// try {
				ajax(url, doneFunc, timeoutMs, timeoutFunc)
				// } catch(e) {
				// 	console.log(`blockingAjax err, likely timeout: ${e}, will just call it done, its not a real error.`)
				// 	resolve('')
				// }
			});
		}

		function checkCanShowForm() {
			grecaptcha.ready(function() {
				grecaptcha.execute(recaptcha_sitekey, {action: 'getInvoiceForm'}).then(function(token) {
					console.log('yeah this happent')
					console.log('whee ' + token)

					// const url= 'http://' + window.location.hostname + ':8081' + '/?t=' + token;
					const url= '/backend/getInvoiceForm/?t=' + token;
					ajax(url, showFormIfAllowed)

				});
				console.log('should be ready to do things.')
			});
		}
		function dummyShowForm() {
			console.log("dummyShowForm ere1")
			document.querySelector('#authtoken').value = 'FAKE-AUTH'
			document.querySelector('#button').onclick = generateInvoice
		}

		function showFormIfAllowed(json) {
			resultDecoded = JSON.parse(json)
			console.log(resultDecoded)
			if (resultDecoded && resultDecoded[0]) {
				console.log(`we got a true value, and the rando was: ${resultDecoded[1]}`)
				showForm(resultDecoded[1])
			} else {
				console.log("we DID NOT got a true value")
			}
			showExistingInvoice()
		}

		function showForm(authtoken) {
			document.querySelector('#authtoken').value = authtoken
			document.querySelector('#button').onclick = generateInvoice
		}

		var invoiceInProgress = false
		function setInvoiceInProgress(inProgress) {
			invoiceInProgress = inProgress
			if (inProgress) {
				document.querySelector('#button').disabled = true
			} else {
				document.querySelector('#button').disabled = false
			}
		}
		function generateInvoice() {
			if (invoiceInProgress) {
				console.log("generateInvoice: aborting due to belief that prior one is already in progress.")
				return
			}
			flds = ['authtoken','earmark','amount']
			rules = {
				'amount':'required,int',
				'authtoken':'required',
			}
			submit = {}
			var allValid = true
			for (fld of flds) {
				var valid = true
				inFld = document.querySelector(`#${fld}`)
				if (inFld && inFld.options && inFld.selectedIndex) {
					submit[fld] = inFld.options[inFld.selectedIndex].value; 
				} else {
					submit[fld] = inFld.value
				}
				console.log(`fld ${fld} value is ${submit[fld]}`)

				if (rules[fld]) {
					fldRules = rules[fld].split(',')
					for (rule of fldRules) {
						if (rule == 'required' && !submit[fld]) {
							valid = false
							break
						}
						if (rule == 'int') {
							submit[fld] = parseInt(submit[fld])
						}
						if (rule == 'int' && !(submit[fld] > 0)) {
							valid = false
							break
						}
					}
					if (!valid) {
						allValid = false
					}

					fldLbl = document.querySelector(`#lbl_${fld}`)
					if (!fldLbl) {
						continue
					}

					setColor = ""
					if (!valid) {
						setColor = 'red'
					}
					fldLbl.style.color = setColor
				}
			}
			// allValid = false
			if (!allValid) {
				console.log('form had some errors, not going to generate invoice yet.')
				return
			}

			paramsString = encodeURIComponent(JSON.stringify(submit))

			function showHonkler() {
				honkhonk = document.querySelector('#honkler')
				honkhonk.style.display = 'block'
			}
			function hideHonkler() {
				honkhonk = document.querySelector('#honkler')
				honkhonk.style.display = 'none'
			}

			setInvoiceInProgress(true)
			showHonkler()

			grecaptcha.ready(function() {
				grecaptcha.execute(recaptcha_sitekey, {action: 'getInvoice'}).then(function(token) {
					url = '/backend/getInvoice/?p=' + paramsString + '&t=' + token;
					ajax(url, function(text){
						hideHonkler()
						showInvoice(text)
					})
				});
			});
		}

		qrElId = 'qrcode'
		payReqTextId = 'payreq'
		function showInvoice(invoice) {
			if (invoice == "") {
				setInvoiceInProgress(false)
				return
			}
			console.log(invoice)
			console.log("now show it as a qr code.")
			qrEl = document.querySelector(`#${qrElId}`)
			while (qrEl.hasChildNodes()) {
			  qrEl.removeChild(qrEl.firstChild);
			}
			var qrcode = new QRCode(qrElId, {
			    text: invoice,
			    width: 256,
			    height: 256,
			    colorDark : "#000000",
			    colorLight : "#ffffff",
			    correctLevel : QRCode.CorrectLevel.H
			});
			document.querySelector(`#${qrElId}`).style.display = 'block'
			document.querySelector(`#${payReqTextId}`).innerText = invoice
			longPollForPayment()
		}
		function showInvoiceTest() {
			showInvoice(document.getElementById('earmark').value)
		}

		longPollTimeout = 295000
		async function longPollForPayment(testRhash) {
			console.log('longPollForPayment, here setting up')
			paid = false
			url = '/backend/longPollInvoice/'
			if (testRhash) {
				url = url + '?rhash=' + testRhash
			}
			invalid = false
			while (true) {
				// try {
				resultJson = await blockingAjax(url, longPollTimeout)
				// } catch(e) {
					// console.error(e)
				// }
				console.log(`after getting result: ${resultJson}`)
				if (!resultJson) {
					console.log('longPollForPayment, result broken, stop looping.')
					swapCodeForStatus('BROKEN')
					break
				}
				result = JSON.parse(resultJson)
				if (result.invalid) {
					console.log('longPollForPayment, result invalid, stop looping.')
					swapCodeForStatus('INVALID')
					break
				}
				if (result.expired) {
					console.log('longPollForPayment, result expired, stop looping.')
					swapCodeForStatus('EXPIRED')
					break
				}
				if (result.settled) {
					console.log('longPollForPayment, result PAID !!!!!!, stop looping.')
					swapCodeForStatus('PAID')
					break
				}
			}
			setInvoiceInProgress(false)
		}
		function swapCodeForStatus(status) {
			qrEl = document.querySelector(`#${qrElId}`)
			while (qrEl.hasChildNodes()) {
			  qrEl.removeChild(qrEl.firstChild);
			}
			qrEl.innerHTML = `<h1>${status}</h1>`
			document.querySelector(`#${payReqTextId}`).innerText = ""
		}
		function showExistingInvoice() {
			url = '/backend/lastInvoice/'
			ajax(url, showInvoice)
		}

		function testPollForPayment() {
			qrEl = document.querySelector(`#${qrElId}`)
			qrEl.innerHTML = "<h1>QRCODE</h1>"
			qrEl.style.display = "block"
			longPollForPayment('c0f8a567c2972b5ed625a465ffc5f9366428c99d3ffbf27e7b1bcd0503af4b9b')
		}

		injectRecaptchaScript = function() {
			console.log(`adding recaptcha script using site key ${recaptcha_sitekey}`)
			script = document.createElement('script');
			script.type = 'text/javascript';
			script.async = true;
			script.onload = function(){
					// remote script has loaded
					console.log(`added script from ${script.src}, lets roll.`)
					checkCanShowForm()
			};
			script.src = `https://www.google.com/recaptcha/api.js?render=${recaptcha_sitekey}`
			document.getElementsByTagName('head')[0].appendChild(script);
		}

		loadRecaptchaWithSiteKey = function(keyText) {
			recaptcha_sitekey = keyText
			console.log(`got recaptcha site key of ${recaptcha_sitekey} from the backend`)	
			injectRecaptchaScript()
		}
		console.log(`to load recaptcha site key ...`)
		ajax('/backend/getRecaptchaSiteKey/', loadRecaptchaWithSiteKey)

		// document.addEventListener('DOMContentLoaded', function () {
		// 	// dummyShowForm()
		// });
	</script>
	<script type="text/javascript" src="./qrcode.min.js"></script><!-- note this is the KeeeX/qrcodejs version since the original maintainer went away and the code had bugs! -->
</head>
<body>

	<table>
	<input type="hidden" id="authtoken">
	<tr><td id="lbl_amount">Satoshis Amount</td><td><input id="amount" name="amount"></td></tr>
	<!-- <tr><td id="lbl_earmark">Earmark? (optional)</td><td><input id="earmark" name="earmark"></td></tr> -->
	<tr><td id="lbl_earmark">Earmark?</td><td>
		<select name="earmark" id="earmark">
			<option value="skunkworks">Shadow Operations/Skunk Works</option>
			<option value="beach">Beach Cleanup</option>
			<option value="outreach">Homeless Outreach</option>
			<option value="crypto">Cryptocurrency Education</option>
			<option value="media">Media Acquisition Education</option>
			<option value="propaganda">Messaging and Promotion</option>
			<option value="admin">Administration</option>
		</select>
	</td></tr>
	<tr><td id="lbl_btn">&nbsp;</td><td><button id="button" disabled=true>Generate Invoice</button></td></tr>
	</table>
	
	<!-- <button id="button" onclick="testPollForPayment()">Test</button> -->
	<img src="./ezgif-7-51de8928459c.gif" id="honkler" style="display:none">
	<div id="qrcode" style="margin-top:15px; display: none"></div>
	<p style="width: 350px; overflow-wrap: break-word;" id="payreq"></p>
</p>	


</body>
</html>
